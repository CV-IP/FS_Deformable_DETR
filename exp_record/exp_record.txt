twostage base model:
    1. 2021-11-09 11:48 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage_441
    难以复现出来，不知道改动了哪里导致的，11.24发现可能是0.441的模型在评估时过滤掉了不是base的图片，以至于mAP会高一些。之后的训练中val集合都没有过滤。
    2. 2021-11-24 02:41 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_resnet50_q100_twostage_bboxRefine_20211121_0.436
    3. 2021-11-22 03:54 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_100_q_resnet50_1120_0.437
    4. 2021-11-16 08:33 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_100_q_resnet50_1115
    5. 2021-11-16 08:34 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_300_q_resnet101
    6. hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_300_q_resnet50

one stage base model:
1. 2021-11-22 04:42 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_100_q_resnet50_1117_one_stage_0.4229


two stage novel :
    base model is 0.441
    1. do not save, but save log. FS_Deformable_DETR/log/coco_novel_resnet50_q100_twostage_bboxRefine
two stage all :
    base model is 0.441 
    1. 2021-11-24 03:20 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_all_resnet50_q100_twostage_bboxRefine
    log: FS_Deformable_DETR/log/coco_all_resnet50_q100_twostage_bboxRefine

one stage all :
    base model is 0.4229
    1. 2021-11-21 11:06 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_all_resnet50_q100_onestage_bboxRefine
    log: FS_Deformable_DETR/log/coco_all_resnet50_q100_onestage_bboxRefine
one stage novel:
    base model is 0.4229
    1. 2021-11-20 08:05 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_novel_resnet50_q100_onestage_bboxRefine   lr:3e-3
    log: FS_Deformable_DETR/log/coco_novel_resnet50_q100_onestage_bboxRefine lr = 2e-3
    log: FS_Deformable_DETR/log/coco_novel_resnet50_q100_onestage_bboxRefine_2e-4 lr = 2e-4, 50epoch 没有收敛





2021,1111

GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh       \
    --lr_backbone 0     --num_classes 20        --filter_kind novel     --dataset_name coco_all_seed_0_10_shot         \
    --eval_dataset coco_novel       --output_dir exps/coco_novel_100_q_resnet50_seed0_10shot         \
    --batch_size 4  --epochs 200 --lr_drop 50 --lr 2e-5 --resume surgery_model/checkpoint0049_20_classes_resnet50_100q.pth  \
    >  nohup_coco_novel_seed0_10shot_resnet50_1111_resume.out 2>&1 &

command 1：
GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh       \
    --lr_backbone 0     --num_classes 20        --filter_kind novel     --dataset_name coco_all_seed_0_10_shot         \
    --eval_dataset coco_novel       --output_dir exps/coco_novel_100_q_resnet50_seed0_10shot         \
    --batch_size 4  --epochs 200 --lr_drop 50 --lr 2e-4 --resume surgery_model/checkpoint0049_20_classes_resnet50_100q.pth  \
    >  nohup_coco_novel_seed0_10shot_resnet50_1111_resume.out 2>&1 &

    log file : 
    freeze backbone and transformer
    表现：收敛很慢，分类损失下降慢，100epoch map 0.016, epoch 100 停止训练，尝试使用更大的学习率

command 2：
    GPUS_PER_NODE=8 ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh  \           --lr_backbone 0     --num_classes 20        --filter_kind novel     --dataset_name coco_all_seed_0_10_shot             \
    --eval_dataset coco_novel       --output_dir exps/test             --batch_size 4  --epochs 200 --lr_drop 100 --lr 2e-3 \
    --resume exps/coco_novel_100_q_resnet50_seed0_10shot/best_checkpoint.pth 

    freeze backbone and transformer
    表现：收敛较快，30 epoch左右 best map 0.139, 之后开始下降。
    下一步调整， lr_drop 设置为 40， 接着对该步结果进行微调。初始lr设置为2e-4

command 3:
    GPUS_PER_NODE=8 ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh  \      --lr_backbone 0     --num_classes 20        --filter_kind novel     --dataset_name coco_all_seed_0_10_shot             \
    --eval_dataset coco_novel       --output_dir exps/coco_novel_seed0_10shot   --batch_size 4  --epochs 100 --lr_drop 40 --lr 2e-4 \
    --resume --output_dir exps/test/best_checkpoint.pth
    freeze backbone and transformer
    表现：收敛较快，25 epoch左右 best map 0.138,相比于前一阶段的2e-3 的lr，mAP没有继续提高。训练的class error 为0， 已经完全拟合。
    基于上述表现，判断lr应该设置为2e-3， lr_drop 40, 训练epoch 50 / 60。


command :
GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8    configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh       \
    --lr_backbone 0     --num_classes 20        --filter_kind novel     --dataset_name coco_all_seed_0_10_shot         \
    --eval_dataset coco_novel       --output_dir exps/coco_novel_100_q_resnet50_seed0_10shot         --batch_size 4  \
    --epochs 200 --lr_drop 50 --resume surgery_model/checkpoint0049_20_classes_resnet50_100q.pth  \
    >  nohup_coco_novel_seed0_10shot_resnet50_no_freeze_1111_resume.out 2>&1 &

    freeze backbone , not transformer
    表现： 收敛速度可观，但是达到60 epoch左右，map0.11 ，直到90epoch， 基本不变，怀疑可能是50epoch之后学习率减少导致不变。
    想法： 在finetune阶段使用更强的数据增强，查看是否会涨点。 



20211117:
    训练单阶段det：
    command：
    GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement.sh     \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_100_q_resnet50_1117_one_stage     --batch_size 4     --num_queries 100     \
    > nohup_coco_base_1117_100query_resnet50_one_stage.out 2>&1 &
    best mAP : 0.42288658224218634

20211120:   
    重新训练base：
    command :
    GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh     \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_100_q_resnet50_1120_0.437     --batch_size 4     --num_queries 100     \
    >> exps/coco_base_100_q_resnet50_1120/nohup.out 2>&1 &


20211121(实际日期是1122):   
    重新训练base：
    command :
    GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh     \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_resnet50_q100_twostage_bboxRefine_20211121     --batch_size 4     --num_queries 100     \
    >> log/nohup_coco_base_resnet50_q100_twostage_bboxRefine_20211121.log 2>&1 &

20211122:
    突然发现之前的训练都没有freeze input_proj，也就是为了对齐不同阶段的特征图的一个映射变换组，组的大小为特征图的数量，也就是4
20211120:   
    重新训练base 300 q resnet50：
    command :
    GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh     \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_100_q_resnet50_1122     --batch_size 4     --num_queries 300     \
    >> exps/coco_base_300_q_resnet50_1122/nohup.out 2>&1 &
    mAP : 0.437
    checkpoint : 2021-11-25 02:30 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_300_q_resnet50_1122_20211125_437
20211124:
    训练300q， resnet101 base two stage model
    GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh     \
    --backbone resnet101  --num_queries 300 \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_300_q_resnet101_1124     --batch_size 4       \
    >> exps/coco_base_300_q_resnet101_1124/nohup.out 2>&1 &
    exp: 2021-11-26 06:27 hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_300_q_resnet101_1124
    mAP : 0.44435922595377897
20211202:
    微调双阶段网络，相比之前的实验只开放decoder中的box_embed 和class


实验数据：
    coco_base_100_q_resnet50_1115 ： 没有打开transformer，所以无效。



test tmp command :
    GPUS_PER_NODE=8 ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement.sh     \
    --num_classes 60     --dataset_name coco_base_train     --eval_dataset coco_base     --filter_kind base     \
    --output_dir exps/coco_base_100_q_resnet50_1117_one_stage     --batch_size 4     --num_queries 100

test command :

GPUS_PER_NODE=8 nohup ./tools/run_dist_launch.sh 8    configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh       \
    --num_classes 80       --dataset_name coco_all_seed_0_30_shot         \
    --eval_dataset coco_novel       --output_dir exps/test         --batch_size 4  \
    --epochs 50 --lr_drop 40 --resume surgery_model/base_resnet50_q100_twostage_bboxRefine_80_classes.pth  \
    >  nohup_test.out 2>&1 &


GPUS_PER_NODE=8 ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh \
        --lr_backbone 0 --freeze_transformer --num_queries 300 \
        --num_classes 20    \
        --filter_kind novel \
        --dataset_name coco_all_seed_0_30_shot     \
        --eval_dataset coco_novel   \
        --output_dir exps/coco_novel_resnet50_q300_twostage_bboxRefine_newFreeze_drop10/seed0_30shot     \
        --epochs 50 --batch_size 4 --lr 2e-3 --lr_drop 10 \
        --resume surgery_model/base_resnet50_q100_twostage_bboxRefine_20_classes.pth \
        > log/coco_novel_resnet50_q300_twostage_bboxRefine_newFreeze_drop10/seed0}_30shot.log



微调实验：seed 0 shot 10
0)
    q 100
    freeze_exclude = ['class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 40
    epoch 10 ： mAP 0.177
    epoch 15 ： mAP 0.205 
 
1）
    q 300
    freeze_exclude = ['enc_output', 'enc_output_norm', 'pos_trans', 'pos_trans_norm', 'class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 10
    
    epoch 30 ： 0.034
2）
    q 300
    freeze_exclude = ['enc_output', 'enc_output_norm', 'pos_trans', 'pos_trans_norm', 'class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 20
    
    epoch 15 ： mAP  0.031
3）
    q 300
    freeze_exclude = ['enc_output', 'enc_output_norm', 'pos_trans', 'pos_trans_norm', 'class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 20
    
    epoch 15 ： mAP  0.031
    epoch 20 ： mAP  0.035
4）
    q 300
    freeze_exclude = ['class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 20
    
    epoch 20 ： mAP  0.035
5)
    q 100
    freeze_exclude = ['class_embed', 'bbox_embed']
    lr : 2e-3, lr_drop : 20
    
    epoch 20 ： mAP  0.033

上述实验结果极其糟糕的原因在于，没有打开 ‘input_proj’ 这个通道对齐网络的参数更新，只有打开其参数更新，30shot 10 epoch mAP才会提高到18,否则0.03左右一直徘徊。

q 100
    30shot，在学习率都是2e-3的情况下，15shot左右达到峰值附近，10shot则在20shot达到峰值。
    30 shot : 15drop 比 20 drop好， 经过seed 0 30 shot 对比发现15比30的map 多了0.001.最终选择15drop，35epoch 微调。
    10 shot ： maybe 20 drop


20211203: 废弃
    log/coco_novel_resnet50_q100_twostage_bboxRefine_freeze_encoutput_drop15
    freeze param: freeze_exclude = ['input_proj', 'enc_output', 'enc_output_norm', 'pos_trans', 'pos_trans_norm', 'class_embed', 'bbox_embed']
20211204:
    log/coco_novel_resnet50_q100_twostage_bboxRefine_freeze_encoutput_drop15
    freeze param : freeze_exclude = ['input_proj', 'pos_trans', 'pos_trans_norm', 'class_embed', 'bbox_embed']
20211215: 不冻结任何参数
    GPUS_PER_NODE=8 ./tools/run_dist_launch.sh 8 configs/r50_deformable_detr_plus_iterative_bbox_refinement_plus_plus_two_stage.sh \
        --num_queries 100 \
        --num_classes 80    \
        --dataset_name coco_all_seed_${seed}_${shot}_shot     \
        --eval_dataset coco_novel   \
        --output_dir exps/coco_train_all_eval_novel_resnet50_q100_twostage_bboxRefine_no_freeze/seed${seed}_${shot}shot     \
        --epochs 50 --batch_size 4 --lr 2e-4 --lr_drop 40 \
        --resume exps/coco_train_all_eval_novel_resnet50_q100_twostage_bboxRefine_no_freeze/seed${seed}_${shot}shot/checkpoint.pth  \
        >> log/coco_train_all_eval_novel_resnet50_q100_twostage_bboxRefine_no_freeze/seed${seed}_${shot}shot.log

20211220:
    不冻结encoder，冻结backbone， decoder seed0_30shot: best mAP 0.191 train_all_val_novel.(机器被kill，没有保存实验记录) 80 epoch， lr_drop: 40

20211221:
    base train: onestage, no iterative box:
    log: FS_Deformable_DETR/log/coco_base_resnet50_q100_20211221.log
    checkpoint: hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_base_resnet50_q100_20211221

20211223:
    finetune onestage no iterate, 
    log: log/coco_train_all_eval_novel_resnet50_q100_onwstage_NobboxRefine_unfreeze_encoder_20211223
    checkpoint: hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_train_all_eval_novel_resnet50_q100_onwstage_NobboxRefine_unfreeze_encoder_20211223

20211229:
    finetune onestage no iterate, only head
    log: log/coco_train_all_eval_novel_resnet50_q100_onestage_NobboxRefine_freeze_head_20211229
    {"shot": 10, "average mAP": 0.120047959744075,}
    {"shot": 30, "average mAP": 0.1745185486343025,}
    exps:
        hdfs://haruna/home/byte_arnold_lq_vc/user/zhanglibin.buaa/exps/coco_train_all_eval_novel_resnet50_q100_onestage_NobboxRefine_freeze_head_20211229
    
    

    
